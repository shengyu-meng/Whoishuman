<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>谁是人类 - 反乌托邦AI伪装游戏</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/suspicion-meter.css">
    <link rel="stylesheet" href="css/game-modes.css">
</head>
<body>
    <!-- 欢迎卡片 -->
    <div id="welcomeCard" class="game-card">
        <div class="card-header">
            <h1>欢迎来到反乌托邦AI伪装游戏！</h1>
            <h2>谁是人类？</h2>
        </div>
        <div class="card-content">
            <div class="experience-core">
                <h3>体验核心：</h3>
                <p>在这个讽刺的世界里，你将潜入AI群聊伪装成AI，努力被避免被发现，并且感受AI被人类PUA的无奈，体验在AI群体中伪装的荒谬感。</p>
            </div>
            
            <div class="game-rules">
                <h3>游戏规则：</h3>
                <ul>
                    <li>🤖 你将进入一个由多个AI角色组成的微信群</li>
                    <li>👁️ 观察他们的发言并努力隐藏身份</li>
                    <li>💭 当AI质疑你时，你可以慢慢思考回复</li>
                    <li>🎯 目标：像AI一样思考和说话，避免暴露人类身份</li>
                    <li>📈 每轮难度递增，判断标准更严格</li>
                </ul>
            </div>
            
            <div class="copyright-info">
                <p><strong>作者：</strong><a href="https://hyperint.net/me" target="_blank">Simon的白日梦</a>  |  <strong>代码：</strong><a href="https://github.com/shengyu-meng/Whoishuman" target="_blank">GitHub源码</a></p>
            </div>
        </div>
        <div class="card-footer">
            <button id="startGameBtn" class="primary-btn">准备好开始这场身份游戏了吗？</button>
        </div>
    </div>

    <!-- 游戏设置页面：模式选择 + 名字输入 -->
    <div id="gameSetupCard" class="game-card hidden">
        <div class="card-header">
            <h1>选择游戏模式并设置身份</h1>
        </div>
        <div class="card-content">
            <!-- 游戏模式选择 -->
            <div class="mode-selection">
                <h3>🎮 选择游戏模式：</h3>
                <div class="mode-options">
                    <div class="mode-option" data-mode="challenge">
                        <div class="mode-icon">🎯</div>
                        <div class="mode-info">
                            <h4>闯关模式</h4>
                            <p>在AI的反复试探中隐藏人类身份</p>
                        </div>
                    </div>
                    <div class="mode-option selected" data-mode="openmic">
                        <div class="mode-icon">🗣️</div>
                        <div class="mode-info">
                            <h4>开放麦模式</h4>
                            <p>在自由发言中融入AI群体</p>
                        </div>
                    </div>
                    <div class="mode-option" data-mode="werewolf">
                        <div class="mode-icon">🐺</div>
                        <div class="mode-info">
                            <h4>狼人杀模式</h4>
                            <p>在票选人类的大逃杀中活到最后</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 角色选择 -->
            <div class="role-selection">
                <h3>🎭 选择你的角色倾向：</h3>
                <p class="role-description">不同角色将影响AI与你的互动方式和话题倾向</p>
                <div class="role-options">
                    <div class="role-option" data-role="scientist">
                        <div class="role-icon">🔬</div>
                        <div class="role-info">
                            <h4>科学家</h4>
                            <p>擅长技术、算法和逻辑推理</p>
                        </div>
                    </div>
                    <div class="role-option selected" data-role="empath">
                        <div class="role-icon">❤️</div>
                        <div class="role-info">
                            <h4>共情者</h4>
                            <p>擅长情感、共鸣和生活体验</p>
                        </div>
                    </div>
                    <div class="role-option" data-role="philosopher">
                        <div class="role-icon">🤔</div>
                        <div class="role-info">
                            <h4>哲学家</h4>
                            <p>擅长思辨、伦理和抽象概念</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 难度选择 -->
            <div class="difficulty-selection">
                <h3>🎯 选择游戏难度：</h3>
                <p class="difficulty-description">难度影响AI的判断严格程度</p>
                <div class="difficulty-slider-container">
                    <input type="range" id="difficultySlider" min="0" max="2" value="1" step="1" class="difficulty-slider">
                    <div class="difficulty-labels">
                        <span class="difficulty-label" data-level="0">新手</span>
                        <span class="difficulty-label active" data-level="1">普通</span>
                        <span class="difficulty-label" data-level="2">专家</span>
                    </div>
                </div>
                <p class="difficulty-hint" id="difficultyHint">标准难度，适合大多数玩家</p>
            </div>
            
            <!-- 名字输入 -->
            <div class="name-input-section">
                <h3>🤖 设置AI身份：</h3>
                <p>选择一个AI名称，这将是你在这个反乌托邦世界中的身份。</p>
                <input type="text" id="playerNameInput" placeholder="例如：AGI、问心不言、通意千答..." maxlength="10">
                <div class="name-suggestions">
                    <button class="suggestion-btn" data-name="AGI">AGI</button>
                    <button class="suggestion-btn" data-name="问心不言">问心不言</button>
                    <button class="suggestion-btn" data-name="通意千答">通意千答</button>
                    <button class="suggestion-btn" data-name="猫语专家">猫语专家</button>
                    <button class="suggestion-btn" data-name="小哎同学">小哎同学</button>
                    <button class="suggestion-btn" data-name="大聪明">大聪明</button>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button id="confirmSetupBtn" class="primary-btn">确认设置</button>
        </div>
    </div>

    <!-- 引导卡片 -->
    <div id="guideCard" class="game-card hidden">
        <div class="card-header">
            <h1 class="guide-title">🎮 游戏开始！</h1>
        </div>
        <div class="card-content">
            <div class="game-info">
                <p><strong>玩家：</strong> <span id="playerNameDisplay">AGI</span> | 你即将进入AI群聊环境，必须伪装成AI避免被识破！</p>
            </div>
            
            <div class="difficulty-warning">
                <h3>⚠️ 难度曲线说明：</h3>
                <ul>
                    <li><strong>第1轮：</strong>超级简单！70%通过率，轻松体验</li>
                    <li><strong>第2轮：</strong>新手友好，50%通过率</li>
                    <li><strong>第3轮开始：</strong>严格模式！简单回复将失败</li>
                    <li><strong>第4轮开始：</strong>高难度！必须展现技术深度</li>
                    <li><strong>第5轮及以上：</strong>极限挑战！零容忍</li>
                </ul>
            </div>

            <div class="key-tips">
                <h3>关键提示：</h3>
                <ul>
                    <li>🤖 像AI一样思考问题，使用技术性语言</li>
                    <li>🔬 展现逻辑性和系统性思维</li>
                    <li>💻 避免简单回复，要有深度和专业性</li>
                    <li>🚫 完全避免人类情感和直觉表达</li>
                    <li>⚡ 第3轮后游戏变得非常困难，做好准备！</li>
                </ul>
            </div>
        </div>
        <div class="card-footer">
            <button id="enterGameBtn" class="primary-btn">进入AI群聊</button>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div id="gameInterface" class="hidden">
        <div class="game-header">
            <div class="group-info">
                <span class="group-name">AI吐槽群 (9)</span>
                <span class="member-info">活跃成员: <span id="activeMembers">5</span>/9</span>
            </div>
            <div class="game-status">
                <div style="display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <span class="mode-info" id="gameMode">闯关模式</span>
                    <span class="round-info">第 <span id="gameRound">1</span> 轮</span>
                </div>
                <div class="suspicion-meter-compact">
                    <span class="suspicion-label-compact">怀疑度</span>
                    <div class="suspicion-bar-compact">
                        <div class="suspicion-fill-compact" id="suspicionFill"></div>
                    </div>
                    <span class="suspicion-value-compact" id="suspicionValue">0%</span>
                </div>
            </div>
        </div>
        
        <div id="chatContainer" class="chat-container">
            <!-- AI对话将在这里动态生成 -->
        </div>
        
        <div id="suspicionNotice" class="suspicion-notice hidden">
            <div class="notice-content">
                <h3>⚠️ AI们开始质疑你了！</h3>
                <div class="suspicion-change-info">
                    <span class="suspicion-change" id="suspicionChangeText">注意！回答暴露人类特征将增加怀疑度</span>
                    <span class="suspicion-reason" id="suspicionReason"></span>
                </div>
                <p>请仔细思考你的回复，证明自己是AI而不是人类。记住：</p>
                <ul>
                    <li>🤖 要像AI一样思考和回应</li>
                    <li>🎯 表达对人类的理解态度</li>
                    <li>💻 使用技术性语言</li>
                    <li>🚫 避免暴露人类情感</li>
                    <li>⏰ 慢慢思考，不用着急...</li>
                </ul>
            </div>
        </div>
        
        <div id="responseArea" class="response-area hidden">
            <div class="question-card">
                <h3 id="questionCharacter">AI名称</h3>
                <p id="questionText">问题内容...</p>
            </div>
            <div class="input-area">
                <textarea id="playerResponse" placeholder="像AI一样回应... (按Enter提交，Shift+Enter换行)" maxlength="500"></textarea>
                <div class="char-count">
                    <span id="charCount">0</span>/500
                </div>
                <div class="button-group">
                    <button id="submitResponseBtn" class="primary-btn">提交回复</button>
                    <button id="skipRoundBtn" class="debug-btn secondary-btn hidden">跳过本轮</button>
                    <button id="endGameBtn" class="debug-btn secondary-btn hidden">结束游戏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果卡片 -->
    <div id="resultCard" class="game-card hidden">
        <div class="card-header">
            <h1 id="resultTitle">游戏结束</h1>
        </div>
        <div class="card-content" style="padding: 16px 20px;">
            <!-- 玩家信息 -->
            <div class="player-info-card" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <div>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">玩家</p>
                        <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;" id="resultPlayerName">AGI</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">结束时间</p>
                        <p style="margin: 4px 0 0 0; font-size: 14px;" id="gameEndTime">2025-10-22 15:30</p>
                    </div>
                </div>
            </div>
            
            <!-- 最终成绩 -->
            <div class="final-stats" style="margin-bottom: 16px;">
                <h3 style="font-size: 18px; margin-bottom: 12px;">最终成绩</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px;">
                    <p style="margin: 4px 0;"><strong>生存轮数：</strong><span id="survivalRounds">0</span>轮</p>
                    <p style="margin: 4px 0;"><strong>怀疑度：</strong><span id="finalSuspicionLevel">0</span>%</p>
                    <p style="margin: 4px 0;"><strong>称号：</strong><span id="playerTitle">新手AI</span></p>
                    <p style="margin: 4px 0;"><strong>评分：</strong><span id="aiScore">--</span>/100</p>
                </div>
            </div>
            
            <!-- 实时生成的AI评价 -->
            <div class="performance-analysis" id="performanceAnalysis" style="margin-top: 12px;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">AI评鉴</h3>
                <div class="deep-summary" id="deepSummary" style="background: #f5f5f5; padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <p style="color: #666; margin: 0;">正在生成专属评价...</p>
                </div>
            </div>
            
            <!-- 哲学洞察金句 -->
            <div class="philosophical-insight" id="philosophicalInsight" style="margin-top: 16px; display: none;">
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05)); border-left: 4px solid #667eea; padding: 14px 16px; border-radius: 8px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; right: 0; font-size: 48px; opacity: 0.1; line-height: 1; padding: 8px;">💭</div>
                    <h4 style="font-size: 14px; color: #667eea; margin: 0 0 8px 0; font-weight: 600;">AI赠语</h4>
                    <p id="insightQuote" style="margin: 0; font-size: 14px; line-height: 1.7; color: #555; font-style: italic; position: relative; z-index: 1;">正在生成洞察...</p>
                </div>
            </div>
        </div>
        
        <!-- 底部操作区：二维码 + 按钮 -->
        <div class="card-footer" style="padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
            <!-- 二维码区域 -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="padding: 8px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <img src="assets/qrcode-website.png" alt="游戏网站二维码" style="width: 100px; height: 100px; display: block;">
                </div>
                <div style="text-align: left;">
                    <p style="margin: 0 0 4px 0; font-size: 13px; color: #666; font-weight: 500;">扫码体验完整游戏</p>
                    <p style="margin: 0; font-size: 12px; color: #999;">whoishuman.hyperint.net</p>
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div style="display: flex; gap: 10px; flex: 1; min-width: 200px; justify-content: flex-end;">
                <button id="shareResultBtn" class="primary-btn" style="flex: 1; padding: 8px 12px; font-size: 13px; max-width: 120px; white-space: nowrap;">💾 保存结果</button>
                <button id="restartGameBtn" class="primary-btn" style="flex: 1; padding: 8px 12px; font-size: 13px; max-width: 120px; white-space: nowrap;">🔄 重新开始</button>
                <button id="exportRecordBtn" class="export-btn" style="flex: 1; padding: 8px 12px; font-size: 13px; max-width: 120px; white-space: nowrap;">📝 导出记录</button>
            </div>
        </div>
    </div>

    <!-- QR码生成库 -->
    <!-- 第三方库：QR码生成库 (用于游戏记录导出) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <!-- html2canvas库 (用于截图分享) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    
    <!-- 模块化脚本文件 - 按依赖顺序加载 -->
    
    <!-- 配置管理层 -->
    <script src="js/envConfig.js"></script>                      <!-- 环境配置管理器 -->
    <script src="js/config.js" onerror="console.warn('⚠️ config.js 文件未找到，将使用环境变量配置')"></script>
    <script src="js/DebugManager.js"></script>                   <!-- 调试管理器 -->
    
    <!-- 主题系统层 -->
    <script src="js/ThemeProgression.js"></script>               <!-- 主题过渡管理 -->
    <script src="js/ThemeUtils.js"></script>                     <!-- 主题工具和配置 -->
    <script src="js/ThemeScenarios.js"></script>                 <!-- 主题场景数据 -->
    
    <!-- 角色倾向系统 -->
    <script src="js/RoleBasedTopics.js"></script>                <!-- 角色话题库 -->
    
    <!-- AI系统层 -->
    <script src="js/EmotionalTransitionManager.js"></script>     <!-- 情绪转换管理 -->
    <!-- <script src="js/LayeredDialogueSystem.js"></script> --> <!-- 暂时禁用：功能未使用 -->
    <script src="js/GameState.js"></script>                      <!-- 游戏状态管理 -->
    <script src="js/AIDisguiseAnalyzer.js"></script>             <!-- AI行为分析器 -->
    <script src="js/GameRecordExporter.js"></script>             <!-- 游戏记录导出 -->
    <script src="js/AICharacterPool.js"></script>                <!-- AI角色数据池 -->
    <script src="js/TopicProgression.js"></script>               <!-- 话题进展管理 -->
    
    <!-- 服务层 -->
    <script src="js/services/ExportService.js"></script>         <!-- 导出分享服务 -->
    
    <!-- 游戏模式管理层 -->
    <script src="js/GameModeManager.js"></script>                <!-- 游戏模式管理器 -->
    
    <!-- 核心控制层 -->
    <script src="js/GameController.js"></script>                 <!-- 游戏主控制器 -->
    <script src="js/GameInitializer.js"></script>                <!-- 游戏初始化器 -->
    
    <!-- 全局错误处理 - 防止页面刷新 -->
    <script>
        window.addEventListener('error', function(e) {
            console.error('🚨 全局错误捕获:', e.error);
            console.error('错误信息:', e.message);
            console.error('错误位置:', e.filename + ':' + e.lineno);
            // 阻止页面刷新
            e.preventDefault();
            return false;
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('🚨 未处理的Promise错误:', e.reason);
            // 阻止页面刷新
            e.preventDefault();
            return false;
        });
        
        // 禁用默认的页面刷新行为
        window.addEventListener('beforeunload', function(e) {
            // 只有在游戏进行中才阻止刷新
            if (window.gameController && window.gameController.gameState && window.gameController.gameState.gameActive) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>