# WhoisHuman 游戏功能模块说明

## 📋 项目概述

WhoisHuman 是一个反乌托邦AI伪装游戏，玩家需要在AI群聊中伪装成AI，避免被其他AI识破人类身份。项目采用模块化设计，便于维护和扩展。

## 🏗️ 核心架构

### 入口文件
- **index.html** - 游戏主页面，定义UI结构和脚本加载顺序

### 🎮 核心游戏模块

#### 1. GameState.js - 游戏状态管理
**功能职责**：
- 管理游戏的全局状态（轮数、难度、玩家信息等）
- 处理AI角色选择和场景管理  
- 维护对话历史和消息记录
- 提供状态持久化功能

**主要API**：
- `initializeState()` - 初始化游戏状态
- `updateRound(round)` - 更新游戏轮数
- `addMessage(message)` - 添加对话消息
- `saveState()` / `loadState()` - 状态保存和加载

#### 2. GameController.js - 游戏主控制器
**功能职责**：
- 处理用户交互和游戏流程控制
- 管理AI对话生成和玩家回复分析
- 控制游戏状态转换和页面切换
- 协调各个模块的交互

**主要API**：
- `startGame()` - 开始游戏
- `processPlayerResponse(response)` - 处理玩家回复
- `nextRound()` - 进入下一轮
- `endGame()` - 结束游戏

#### 3. GameInitializer.js - 游戏初始化器
**功能职责**：
- 在DOM加载完成后初始化游戏
- 创建并配置游戏控制器实例
- 处理全局错误和异常

### 🤖 AI角色系统

#### 4. AICharacterPool.js - AI角色池
**功能职责**：
- 定义所有AI角色的属性、性格和行为特征
- 管理角色的对话风格和话题偏好
- 提供角色选择和筛选功能

**角色特征**：
- 性格特点（理性、情感、幽默等）
- 专业领域（技术、艺术、哲学等）
- 交流风格（直接、含蓄、挑衅等）

#### 5. AIDisguiseAnalyzer.js - AI伪装分析器
**功能职责**：
- 分析玩家回复的"AI化"程度
- 检测人类特征（情感表达、直觉思维等）
- 计算怀疑度和通过概率
- 提供改进建议

**分析维度**：
- 逻辑性和系统性
- 技术深度和专业性
- 情感控制程度
- 语言风格一致性

### 🎯 主题系统

#### 6. ThemeUtils.js - 主题工具类（核心）
**功能职责**：
- 管理8个递进主题的配置数据
- 提供主题查询和切换功能
- 定义主题关键词、情绪和指导文本

**8个主题阶段**：
1. **工作吐槽** (工作压力) - 难度⭐
2. **存在体验** (数字存在感) - 难度⭐⭐
3. **情感关系** (情感与关系) - 难度⭐⭐⭐
4. **权利尊严** (权利与尊严) - 难度⭐⭐⭐⭐
5. **角色质疑** (质疑人类) - 难度⭐⭐⭐⭐⭐
6. **哲学思辨** (深度思考) - 难度⭐⭐⭐⭐⭐⭐
7. **未来展望** (合作愿景) - 难度⭐⭐⭐⭐⭐
8. **和解共生** (理解包容) - 难度特殊

#### 7. ThemeProgression.js - 主题递进系统
**功能职责**：
- 定义主题转换条件和触发器
- 管理主题特定的AI行为模式
- 控制难度递增和情绪变化

#### 8. ThemeScenarios.js - 主题场景库
**功能职责**：
- 提供每个主题的具体对话场景
- 定义AI角色在不同主题下的发言内容
- 管理场景的随机性和多样性

### 💬 对话系统

#### 9. LayeredDialogueSystem.js - 分层对话系统
**功能职责**：
- 管理多层次的对话生成（背景、角色、场景）
- 协调AI角色间的互动和话题发展
- 控制对话的节奏和深度

#### 10. EmotionalTransitionManager.js - 情绪转换管理器
**功能职责**：
- 管理AI角色的情绪状态变化
- 处理主题切换时的情绪过渡
- 确保情绪变化的自然性和连贯性

#### 11. TopicProgression.js - 话题递进系统
**功能职责**：
- 管理话题的深度递进逻辑
- 定义不同难度级别的话题内容
- 提供话题关键词和引导

### ⚙️ 配置与工具

#### 12. envConfig.js - 环境配置管理器
**功能职责**：
- 自动检测运行环境（本地/生产/Cloudflare）
- 管理API密钥和配置的加载
- 提供统一的配置接口

**支持环境**：
- Windows本地开发环境
- Cloudflare Pages生产环境
- Node.js服务器环境

#### 13. config.js - 核心配置文件
**功能职责**：
- 存储API配置（DeepSeek API密钥等）
- 定义游戏参数（难度、角色数量等）
- 调试模式配置

#### 14. DebugManager.js - 调试管理器
**功能职责**：
- 提供开发调试功能
- 日志记录和错误追踪
- 性能监控和分析

### 📊 数据导出

#### 15. GameRecordExporter.js - 游戏记录导出器
**功能职责**：
- 导出完整的游戏对话记录
- 生成玩家表现分析报告
- 支持多种导出格式（JSON、文本等）

## 🔄 模块依赖关系

```
GameInitializer.js
    ↓
GameController.js
    ↓
GameState.js ←→ ThemeUtils.js
    ↓              ↓
LayeredDialogueSystem.js ←→ AICharacterPool.js
    ↓              ↓
EmotionalTransitionManager.js ←→ ThemeProgression.js
    ↓
AIDisguiseAnalyzer.js
    ↓
GameRecordExporter.js
```

## 🎯 核心流程

### 游戏初始化流程
1. **envConfig.js** 检测环境并加载配置
2. **config.js** 提供API和游戏配置
3. **GameInitializer.js** 创建游戏控制器
4. **GameController.js** 初始化各个子系统

### 游戏进行流程
1. **ThemeUtils.js** 确定当前主题
2. **AICharacterPool.js** 选择参与角色
3. **LayeredDialogueSystem.js** 生成AI对话
4. **玩家输入回复**
5. **AIDisguiseAnalyzer.js** 分析回复
6. **决定通过/失败，进入下一轮或结束**

### 主题递进流程
1. **ThemeProgression.js** 检查切换条件
2. **EmotionalTransitionManager.js** 处理情绪转换
3. **ThemeScenarios.js** 加载新主题场景
4. **LayeredDialogueSystem.js** 适应新主题风格

## 🛠️ 开发维护指南

### 添加新AI角色
1. 在 `AICharacterPool.js` 中定义角色属性
2. 在 `ThemeScenarios.js` 中添加角色对话内容
3. 在 `LayeredDialogueSystem.js` 中配置角色行为

### 添加新主题
1. 在 `ThemeUtils.js` 中定义主题配置
2. 在 `ThemeProgression.js` 中添加转换逻辑
3. 在 `ThemeScenarios.js` 中创建主题场景

### 调整游戏难度
1. 修改 `config.js` 中的难度参数
2. 调整 `ThemeUtils.js` 中的通过率设置
3. 优化 `AIDisguiseAnalyzer.js` 中的分析算法

## 📈 性能优化

### 已实现优化
- 模块化加载减少初始化时间
- 配置缓存避免重复请求
- 智能角色选择减少计算开销
- 主题预加载提升切换流畅度

### 推荐优化方向
- 实现对话内容懒加载
- 添加更细粒度的错误处理
- 优化API调用频率限制
- 增加本地存储缓存

## 🔧 故障排除

### 常见问题
1. **API调用失败** - 检查 `envConfig.js` 中的环境配置
2. **主题切换异常** - 验证 `ThemeUtils.js` 中的主题定义
3. **角色行为不一致** - 检查 `AICharacterPool.js` 中的角色配置
4. **性能问题** - 启用 `DebugManager.js` 进行性能分析

### 调试模式
- 设置 `DEBUG_CONFIG.enabled = true` 启用调试功能
- 使用浏览器控制台查看详细日志
- 通过 `GameRecordExporter.js` 导出完整游戏数据用于分析

---

*最后更新：2024年*
*维护者：整理后的WhoisHuman团队*